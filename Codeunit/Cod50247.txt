OBJECT Codeunit 50247 MATMUT DARVA Sent DRT Gen. Act
{
  OBJECT-PROPERTIES
  {
    Date=24/02/14;
    Time=14:43:17;
    Modified=Yes;
    Version List=IMH6.01,MATMUT01;
  }
  PROPERTIES
  {
    TableNo=8016720;
    Permissions=TableData 17=r,
                TableData 18=r,
                TableData 25=r,
                TableData 5900=r,
                TableData 50000=r,
                TableData 50012=r,
                TableData 50021=r,
                TableData 50058=r,
                TableData 50066=r,
                TableData 50075=r,
                TableData 50124=r,
                TableData 50126=r,
                TableData 50164=r,
                TableData 8016707=r,
                TableData 8016720=rimd,
                TableData 8016722=ri,
                TableData 8016723=ri,
                TableData 8016724=ri,
                TableData 8016725=ri,
                TableData 8016726=ri,
                TableData 8016748=r;
    OnRun=VAR
            lEAISentMQBuffer@1100281000 : TEMPORARY Record 8016720;
          BEGIN
            lEAISentMQBuffer := Rec;
            Code(lEAISentMQBuffer);
            lEAISentMQBuffer.CALCFIELDS("XML Source");
            "XML Source" := lEAISentMQBuffer."XML Source";
            Rec := lEAISentMQBuffer;
          END;

  }
  CODE
  {
    VAR
      EAISetup@1100281004 : Record 8016700;
      EAIXMLDocMgt@1100281003 : Codeunit 8016713;
      Text000@1100281000 : TextConst 'ENU=sch:SoumettreDemandeReglementReparateurAGPMDemande;FRA=sch:SoumettreDemandeReglementReparateurAGPMDemande';
      Text001@1100281001 : TextConst 'ENU=sch:SoumettreDemandeReglementReparateurMACIFDemande;FRA=sch:SoumettreDemandeReglementReparateurMACIFDemande';
      Text002@1000000000 : TextConst 'ENU=Invoice no. must be lower than 17 caracters.;FRA=Le nø de facture ne doit pas exc‚der 17 caractŠres.';
      Text003@1000000001 : TextConst 'ENU=SDR64 not be sent.;FRA=Un SDR64 n''a pas ‚t‚ pr‚alablement ‚mis pour ce prestataire pour cette mission."';
      Text004@1000000002 : TextConst 'ENU=DARVA flow can not be generated;FRA=Le flux darva n''a pas pu g‚n‚r‚';
      Text005@1100281002 : TextConst 'ENU=Any invoice linked;FRA=Pas de facture associ‚e.';
      Text006@1100281005 : TextConst 'ENU=SDR64 answer was not filled (numeroPartie);FRA=La r‚ponse au SDR64 n''est pas pr‚sente (numeroPartie)';
      DARVAXMLMgt@1000000003 : Codeunit 50252;
      CodeDesc@1000000004 : Record 50079;

    LOCAL PROCEDURE Code@1100281001(VAR pEAISentMQBuffer@1100281000 : Record 8016720);
    VAR
      lDocumentAttachment@1100281012 : Record 50021;
      lFile@1100281019 : Record 2000000022;
      lEAIAct@1100281015 : Record 8016706;
      lEAIPartner@1100281014 : Record 8016707;
      lService@1100281011 : Record 50066;
      lServiceHeader@1100281003 : Record 5900;
      lServiceInterventionLine@1100281009 : Record 50075;
      lVendorLedgerEntry@1100281017 : Record 25;
      lProvider@1000000000 : Record 50000;
      lEAIDocEntryMgt@1100281002 : Codeunit 8016707;
      lRecRef@1100281013 : RecordRef;
      lXMLDocument@1100281001 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{88D96A05-F192-11D4-A65F-0040963251E5}:'Microsoft XML, v6.0'.DOMDocument60";
      lLevel0@1100281010 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel1@1100281004 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel2@1100281007 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel3@1100281008 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel4@1000000001 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel5@1000000006 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lInStream@1100281005 : InStream;
      lNameSpace@1100281006 : Text[250];
      lSchURL@1000000003 : Text[150];
      lBigText@1100281021 : BigText;
      lNsURL@1000000002 : Text[150];
    BEGIN
      CLEAR(lXMLDocument);
      CREATE(lXMLDocument);

      lEAIPartner.GET(pEAISentMQBuffer."EAI Partner Code");

      lRecRef.GET(pEAISentMQBuffer.RecordId);
      lRecRef.SETRECFILTER;
      lRecRef.LOCKTABLE;
      lRecRef.FINDFIRST;
      lRecRef.SETTABLE(lVendorLedgerEntry);

      CheckDRT(lVendorLedgerEntry,lDocumentAttachment);
      lService.GET(lVendorLedgerEntry."Service No.");
      lServiceHeader.GET(lServiceHeader."Document Type"::Invoice,lVendorLedgerEntry."Service Header No.");
      lServiceHeader.CALCFIELDS("SDR64 Send");
      lServiceInterventionLine.GET(lVendorLedgerEntry."Service Header No.",lVendorLedgerEntry."Intervention Line No.");
      lProvider.GET(lServiceInterventionLine."Provider No.");

      IF NOT CreateFlow(
           lService,lServiceHeader,lVendorLedgerEntry,
           lProvider,lBigText,lDocumentAttachment,
           pEAISentMQBuffer."EAI Partner Code")
      THEN BEGIN
        ERROR(Text004);
      END;
      //Root Node
      lXMLDocument.async := FALSE;
      pEAISentMQBuffer.GetNamespaceFromExchangeType(lSchURL,lNsURL);
      DARVAXMLMgt.SetSendURL(lSchURL,lNsURL);

      DARVAXMLMgt.SetType(1);
      lXMLDocument.setProperty('SelectionNamespaces',DARVAXMLMgt.GetSelectionNameSpace);
      DARVAXMLMgt.CreateWSHeaderDRT(lXMLDocument,lLevel0,lEAIPartner.Username,lEAIPartner.Password, lSchURL, lNsURL);
      WITH EAIXMLDocMgt DO BEGIN
        lNameSpace := DARVAXMLMgt.GetNameSpace(1);
        EAIXMLDocMgt.AddElement(lLevel0,'sch:DeposerDocumentDemande','',lNameSpace,lLevel1);
        DARVAXMLMgt.Sent_InsertContextDRT(lEAIPartner,lLevel1);
        //<<IMH02.PC
        //DARVAXMLMgt.Sent_InsertService(lEAIPartner,lService,lLevel1);
        //DARVAXMLMgt.Sent_InsertPartners(lEAIPartner,lServiceHeader,lLevel1);
        //>>IMH02.PC
        lNameSpace := DARVAXMLMgt.GetNameSpace(2);
        AddElement(lLevel1,'ns:fluxRefMessage','',lNameSpace,lLevel2);
        AddElement(lLevel2,'ns:typeMessage','',lNameSpace,lLevel3);
        AddElement(lLevel3,'ns:codeMessage','38',lNameSpace,lLevel4);
        AddElement(lLevel3,'ns:verMessage','01',lNameSpace,lLevel4);
        AddElement(lLevel3,'ns:relMessage','01',lNameSpace,lLevel4);
        AddElement(lLevel2,'ns:flux','',lNameSpace,lLevel3);
        AddCDATAElement(lLevel3,'ns:flux',lBigText,lNameSpace);
        AddElement(lLevel1,'ns:piecesJointes','',lNameSpace,lLevel2);
        AddElement(lLevel2,'ns:pieceJointe','',lNameSpace,lLevel3);
        AddElement(lLevel3,'ns:metadata','',lNameSpace,lLevel4);
        AddElement(lLevel4,'ns:idPJ',lDocumentAttachment."GUID Fusion Code",lNameSpace,lLevel5);
        AddElement(lLevel4,'ns:libellePJ',lDocumentAttachment."Description 2",lNameSpace,lLevel5);
        AddElement(lLevel4,'ns:typePJ','FA',lNameSpace,lLevel5);
        AddElement(lLevel4,'ns:naturePJ','999',lNameSpace,lLevel5);
        AddElement(lLevel4,'ns:formatPJ',GetFormatAttachment(lDocumentAttachment."File Extension"),lNameSpace,lLevel5);
        lDocumentAttachment.GetFile(lFile);
        //<<IMH02.PC
        //AddFileElement(lLevel3,'ns:fluxPJ',lFile.Path + lFile.Name,lNameSpace,lLevel4);
        AddFileElementWithoutAttribute(lLevel3,'ns:fluxPJ',lFile.Path + lFile.Name,lNameSpace,lLevel4);
        //>>IMH02.PC
      END;

      //<<IMH11.ACO
      CLEAR(pEAISentMQBuffer."XML Source");
      //>>IMH11.ACO
      pEAISentMQBuffer."XML Source".CREATEINSTREAM(lInStream);
      lXMLDocument.save(lInStream);

      lEAIDocEntryMgt.AddEntryFromSentBuffer(
        DATABASE::Vendor,lVendorLedgerEntry."Entry No.",
        lProvider."No.",lVendorLedgerEntry."Document No.",0, pEAISentMQBuffer);
    END;

    LOCAL PROCEDURE CreateFlow@1100281000(pService@1100281010 : Record 50066;pServiceHeader@1100281009 : Record 5900;pVendorLedgerEntry@1100281011 : Record 25;pProvider@1000000007 : Record 50000;VAR pBigText@1000000008 : BigText;pDocumentAttachment@1100281016 : Record 50021;pEAIPartnerCode@1100281000 : Code[20]) rValue : Boolean;
    VAR
      lTempBlobBuffer@1100281004 : TEMPORARY Record 99008535;
      lDARVADTStorage@1100281003 : Record 50124;
      lXMLDocument@1100281008 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{88D96A05-F192-11D4-A65F-0040963251E5}:'Microsoft XML, v6.0'.DOMDocument60";
      lLevel1@1100281006 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lNameSpace@1000000000 : Text[250];
      lOutStream@1000000009 : OutStream;
      lInStream@1100281002 : InStream;
      lLastStorageEntryNo@1100281001 : Integer;
    BEGIN
      rValue := FALSE;

      lDARVADTStorage.SETRANGE("Service No.",pService."Service No.");
      lDARVADTStorage.SETRANGE("Service Header No.",pServiceHeader."No.");
      lDARVADTStorage.FINDLAST;
      lLastStorageEntryNo := lDARVADTStorage."Entry No.";

      lNameSpace := 'http://www.darva.com/messages/habitation/ir2/';

      //Root Node
      CreateHeaderFlow(lXMLDocument,'ME380101',lLevel1);
      WITH EAIXMLDocMgt DO BEGIN
        AddAttribute(lLevel1,'version','3.0');
        AddAttribute(lLevel1,'xmlns',lNameSpace);

        // Segment TRANSPORT TELEMANTIQUE - SE0010201
        CreateTeleSegment(pService,pServiceHeader,lLevel1,lLastStorageEntryNo,lNameSpace);

        // Segment SECURITE - SE0590301
        CreateSecuritySegment(lLevel1,lNameSpace);

        // Segment LIEN AVEC LES PIECES JOINTES - SE2620101
        CreateAttachmentSegment(lLevel1,pDocumentAttachment,lNameSpace);

        // Segment ENVELOPPE REGLEMENT - SE0520501
        CreatePaymentSegment(pVendorLedgerEntry,lLevel1,lNameSpace);

        // Segment GROUPE SEGMENT ENTREPRISE - GR010101
        CreateCorporateGroupSegment(pService,pServiceHeader,lLevel1,lLastStorageEntryNo,lNameSpace);

        // Segment COMMENTAIRES - SE0120102
        CreateCommentSegment(pDocumentAttachment,lLevel1,lNameSpace);

        // Segment GROUPE SEGMENT PERSONNE - GR050701 - ASSURE
        CreatePersonGroupSegment(pServiceHeader,pVendorLedgerEntry,lLevel1,lNameSpace);

        // REGLEMENT EFFECTUE
        CreatePaymentDoneSegment(pVendorLedgerEntry,lLevel1,lNameSpace);

        // REGLEMENT DES TRAVAUX
        CreateWorkPaymentGroup(pVendorLedgerEntry,lLevel1,pEAIPartnerCode,lNameSpace);
      END;

      lTempBlobBuffer.Blob.CREATEOUTSTREAM(lOutStream);
      lXMLDocument.save(lOutStream);
      lTempBlobBuffer.Blob.CREATEINSTREAM(lInStream);
      pBigText.READ(lInStream);

      rValue := TRUE;
    END;

    LOCAL PROCEDURE CreateTeleSegment@1100281006(pService@1100281007 : Record 50066;pServiceHeader@1100281004 : Record 5900;VAR pLevel1@1100281000 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";pLastStorageEntryNo@1100281006 : Integer;pNameSpace@1100281003 : Text[250]);
    VAR
      lDARVADTStorage@1100281005 : Record 50124;
      lLevel2@1100281001 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel3@1100281002 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lTextBuffer@1100281008 : Text[1024];
    BEGIN
      // Segment TRANSPORT TELEMANTIQUE - SE0010201

      WITH EAIXMLDocMgt DO BEGIN
        AddElement(pLevel1,'SE0010201','',pNameSpace,lLevel2);
        AddElement(lLevel2,'DE00380101',pServiceHeader."DARVA Recipient Subscriber No.",pNameSpace,lLevel3);
        AddElement(lLevel2,'DE00390101',GetDARVACarrierSubNo(pServiceHeader),pNameSpace,lLevel3);
        //AddElement(lLevel2,'DT90290202','',pNameSpace,lLevel3);
        //AddAttribute(lLevel3,'code','38');
        //AddElement(lLevel2,'DE00410101','01',pNameSpace,lLevel3);
        //AddElement(lLevel2,'DE00420101','01',pNameSpace,lLevel3);
        lDARVADTStorage.RESET;
        lDARVADTStorage.SETRANGE("Service No.",pService."Service No.");
        lDARVADTStorage.SETRANGE("Service Header No.",pServiceHeader."No.");
        lDARVADTStorage.SETRANGE("Tag Type",lDARVADTStorage."Tag Type"::Tag);
        lDARVADTStorage.SETRANGE("Entry No.",pLastStorageEntryNo);
        lDARVADTStorage.SETRANGE("Tag Description",'DE00440101');
        IF lDARVADTStorage.FINDFIRST THEN BEGIN
          lTextBuffer :=
            lDARVADTStorage."Value 1" + lDARVADTStorage."Value 2" + lDARVADTStorage."Value 3" +
            lDARVADTStorage."Value 4" + lDARVADTStorage."Value 5";
          AddElement(lLevel2,'DE00440101',lTextBuffer,pNameSpace,lLevel2);
        END;
      END;
    END;

    LOCAL PROCEDURE CreateSecuritySegment@1100281007(VAR pLevel1@1100281001 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";pNameSpace@1100281004 : Text[250]) rValue : Integer;
    VAR
      lLevel2@1100281002 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel3@1100281003 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
    BEGIN
      // Segment SECURITE - SE0590301 - donn‚es issues de la DT

      WITH EAIXMLDocMgt DO BEGIN
        AddElement(pLevel1,'SE0590301','',pNameSpace,lLevel2);
        AddElement(lLevel2,'DE00450101',FORMAT(TODAY,0,9),pNameSpace,lLevel3);
        AddElement(lLevel2,'DT90880101','',pNameSpace,lLevel3);
        AddAttribute(lLevel3,'code','1');
        AddElement(lLevel2,'DT90890101','',pNameSpace,lLevel3);
        AddAttribute(lLevel3,'code','AB');
      END;
    END;

    LOCAL PROCEDURE CreateAttachmentSegment@1100281008(VAR pLevel1@1100281000 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";pDocumentAttachment@1100281004 : Record 50021;pNameSpace@1100281003 : Text[250]);
    VAR
      lLevel2@1100281001 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel3@1100281002 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
    BEGIN
      // Segment LIEN AVEC LES PIECES JOINTES - SE2620101

      WITH EAIXMLDocMgt DO BEGIN
        AddElement(pLevel1,'SE2620101','',pNameSpace,lLevel2);
        AddElement(lLevel2,'DE11870101',FORMAT(CREATEGUID),pNameSpace,lLevel3);
        AddElement(lLevel2,'DE11880101','0',pNameSpace,lLevel3);
        AddElement(lLevel2,'DT93980101','',pNameSpace,lLevel3);
        AddAttribute(lLevel3,'code','I');
      END;
    END;

    LOCAL PROCEDURE CreatePaymentSegment@1100281009(pVendorLedgerEntry@1100281001 : Record 25;VAR pLevel1@1100281000 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";pNameSpace@1100281008 : Text[250]);
    VAR
      lLevel2@1100281003 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel3@1100281002 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lNumPartie@1000000000 : Text[1024];
    BEGIN
      // Segment ENVELOPPE REGLEMENT - SE0520501

      WITH EAIXMLDocMgt DO BEGIN
        AddElement(pLevel1,'SE0520501','',pNameSpace,lLevel2);
        AddElement(lLevel2,'DT90010101','',pNameSpace,lLevel3);
        AddAttribute(lLevel3,'code','1');
        AddElement(lLevel2,'DE01280102','N',pNameSpace,lLevel3);
        //<<IMH05.PC
        //lInterfaceReference.SETRANGE("Source Table ID",DATABASE::"Service Intervention Line");
        //lInterfaceReference.SETRANGE("Source No.",pVendorLedgerEntry."Service No.");
        //lInterfaceReference.SETRANGE("Source No. 2",pVendorLedgerEntry."Service Header No.");
        //lInterfaceReference.SETRANGE("Source No. 3",pVendorLedgerEntry."Intervention Line No.");
        //lInterfaceReference.FINDFIRST;
        lNumPartie := GetNumPartie(pVendorLedgerEntry);
        IF lNumPartie <> '' THEN BEGIN
        //>>IMH05.PC
          AddElement(lLevel2,'DE01390103',lNumPartie,pNameSpace,lLevel3);
        END;
        //<<IMH14.ACO
        //AddElement(lLevel2,'DE01920201',COPYSTR(pVendorLedgerEntry."Document No.",1,17),pNameSpace,lLevel3);
        AddElement(lLevel2,'DE01920201',COPYSTR(pVendorLedgerEntry."External Document No.",1,17),pNameSpace,lLevel3);
        //>>IMH14.ACO
        AddElement(lLevel2,'DE00340201',FORMAT(pVendorLedgerEntry."Posting Date",0,9),pNameSpace,lLevel3);
      END;
    END;

    LOCAL PROCEDURE CreateCorporateGroupSegment@1100281010(pService@1100281008 : Record 50066;pServiceHeader@1100281009 : Record 5900;VAR pLevel1@1100281001 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";pLastStorageEntryNo@1100281000 : Integer;pNameSpace@1100281007 : Text[250]);
    VAR
      lDARVADTStorage@1100281005 : Record 50124;
      lLevel2@1100281004 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel3@1100281003 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLastStorageEntryNo@1100281006 : Integer;
    BEGIN
        // Segment GROUPE SEGMENT ENTREPRISE - GR010101

      WITH EAIXMLDocMgt DO BEGIN
        lDARVADTStorage.SETRANGE("Service No.",pService."Service No.");
        lDARVADTStorage.SETRANGE("Service Header No.",pServiceHeader."No.");
        lDARVADTStorage.SETRANGE("Tag Type",lDARVADTStorage."Tag Type"::Tag);
        lDARVADTStorage.SETRANGE("Entry No.",pLastStorageEntryNo);
        lDARVADTStorage.SETRANGE("Tag Description",'GR010101');
        IF lDARVADTStorage.FINDFIRST THEN BEGIN
          lLastStorageEntryNo := lDARVADTStorage."Tag Entry No.";
        END;
        AddElement(pLevel1,'GR010101','',pNameSpace,lLevel2);

        // SOCIETE D'ASSURANCE - SE0020101
        lDARVADTStorage.RESET;
        lDARVADTStorage.SETRANGE("Service No.",pService."Service No.");
        lDARVADTStorage.SETRANGE("Service Header No.",pServiceHeader."No.");
        lDARVADTStorage.SETRANGE("Tag Type",lDARVADTStorage."Tag Type"::Tag);
        lDARVADTStorage.SETRANGE("Entry No.",pLastStorageEntryNo);
        lDARVADTStorage.SETRANGE("Parent Tag Entry No.",lLastStorageEntryNo);
        lDARVADTStorage.SETRANGE("Tag Description",'SE0020101');
        IF lDARVADTStorage.FINDFIRST THEN BEGIN
          AddElement(lLevel2,'SE0020101','',pNameSpace,lLevel3);
          GetDTStorage(
            lLevel3,pLastStorageEntryNo,
            pService."Service No.",pServiceHeader."No.",
            pNameSpace,lDARVADTStorage."Tag Entry No.");
        END;

        // GESTIONNAIRE - SE0030401
        lDARVADTStorage.RESET;
        lDARVADTStorage.SETRANGE("Service No.",pService."Service No.");
        lDARVADTStorage.SETRANGE("Service Header No.",pServiceHeader."No.");
        lDARVADTStorage.SETRANGE("Entry No.",pLastStorageEntryNo);
        lDARVADTStorage.SETRANGE("Tag Type",lDARVADTStorage."Tag Type"::Tag);
        lDARVADTStorage.SETRANGE("Parent Tag Entry No.",lLastStorageEntryNo);
        lDARVADTStorage.SETRANGE("Tag Description",'SE0030401');
        IF lDARVADTStorage.FINDFIRST THEN BEGIN
          AddElement(lLevel2,'SE0030401','',pNameSpace,lLevel3);
          GetDTStorage(
            lLevel3,pLastStorageEntryNo,
            pService."Service No.",pServiceHeader."No.",
            pNameSpace,lDARVADTStorage."Tag Entry No.");
        END;

        // COORD. TELECOMMUNICATION - SE1600102
        lDARVADTStorage.RESET;
        lDARVADTStorage.SETRANGE("Service No.",pService."Service No.");
        lDARVADTStorage.SETRANGE("Service Header No.",pServiceHeader."No.");
        lDARVADTStorage.SETRANGE("Entry No.",pLastStorageEntryNo);
        lDARVADTStorage.SETRANGE("Tag Type",lDARVADTStorage."Tag Type"::Tag);
        lDARVADTStorage.SETRANGE("Parent Tag Entry No.",lLastStorageEntryNo);
        lDARVADTStorage.SETRANGE("Tag Description",'SE1600102LIST');
        IF lDARVADTStorage.FINDFIRST THEN BEGIN
          AddElement(lLevel2,'SE1600102LIST','',pNameSpace,lLevel3);
          GetDTStorage(
            lLevel3,pLastStorageEntryNo,
            pService."Service No.",pServiceHeader."No.",
            pNameSpace,lDARVADTStorage."Tag Entry No.");
        END;

        // COORD. INFORMATIQUES - SE2010101
        lDARVADTStorage.RESET;
        lDARVADTStorage.SETRANGE("Service No.",pService."Service No.");
        lDARVADTStorage.SETRANGE("Service Header No.",pServiceHeader."No.");
        lDARVADTStorage.SETRANGE("Entry No.",pLastStorageEntryNo);
        lDARVADTStorage.SETRANGE("Tag Type",lDARVADTStorage."Tag Type"::Tag);
        lDARVADTStorage.SETRANGE("Parent Tag Entry No.",lLastStorageEntryNo);
        lDARVADTStorage.SETRANGE("Tag Description",'SE2010101');
        IF lDARVADTStorage.FINDFIRST THEN BEGIN
          AddElement(lLevel2,'SE2010101','',pNameSpace,lLevel3);
          GetDTStorage(
            lLevel3,lLastStorageEntryNo,
            pService."Service No.",pServiceHeader."No.",
            pNameSpace,lDARVADTStorage."Tag Entry No.");
        END;
      END;
    END;

    LOCAL PROCEDURE CreateCommentSegment@1100281016(pDocumentAttachment@1100281004 : Record 50021;VAR pLevel1@1100281001 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";pNameSpace@1100281000 : Text[250]);
    VAR
      lLevel2@1100281003 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel3@1100281002 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel4@1100281005 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
    BEGIN
      // Segment COMMENTAIRES - SE0120102

      WITH EAIXMLDocMgt DO BEGIN
        AddElement(pLevel1,'SE0120102LIST','',pNameSpace,lLevel2);
        AddElement(lLevel2,'SE0120102','',pNameSpace,lLevel3);
        AddElement(lLevel3,'DT90000101','',pNameSpace,lLevel4);
        AddAttribute(lLevel4,'code','M');
        AddElement(lLevel3,'DE00070201','001',pNameSpace,lLevel4);
        //<<IMH03.PC
        //AddElement(
        //  lLevel3,'DE00080201',
        //  PADSTR(COPYSTR(pDocumentAttachment.Description,1,50),50,' ') +
        //  'FA' +
        //  PADSTR('V1',10,' ') +
        //  '  999',
        //  pNameSpace,lLevel4);
        AddElement(
          lLevel3,'DE00080201',
          //<<IMH10
          //PADSTR(COPYSTR(pDocumentAttachment.Description,1,50),50,' ') +
          PADSTR(ReplaceSpecialChar(COPYSTR(pDocumentAttachment.Description,1,50)),50,' ') +
          //>>IMH10
          '999' +
          PADSTR('V1',10,' ') +
          'FA  ',
          pNameSpace,lLevel4);
        //>>IMH03.PC
      END;
    END;

    LOCAL PROCEDURE CreatePersonGroupSegment@1100281015(pServiceHeader@1100281002 : Record 5900;pVendorLedgerEntry@1100281003 : Record 25;VAR pLevel1@1100281001 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";pNameSpace@1100281007 : Text[250]);
    VAR
      lLevel2@1100281004 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lPersonNo@1100281000 : Code[2];
    BEGIN
      // Segment GROUPE SEGMENT ENTREPRISE - GR010101

      WITH EAIXMLDocMgt DO BEGIN
        lPersonNo := '01';
        AddElement(pLevel1,'GR050701LIST','',pNameSpace,lLevel2);

        // Segment assur‚
        CreateBeneficiaryPersonSegment(pServiceHeader,lLevel2,lPersonNo,pNameSpace);

        // Segment IMH
        lPersonNo := INCSTR(lPersonNo);
        CreateIMHPersonSegment(lLevel2,pServiceHeader."Service No.",lPersonNo,pNameSpace);

        // Segment Expert
        // Test … faire si pr‚sence ou non de l'expert
        lPersonNo := INCSTR(lPersonNo);
        CreateExpertPersonSegment(pServiceHeader,lLevel2,lPersonNo,pNameSpace);

        // Segment Prestataire
        CreateProviderPersonSegment(pServiceHeader,pVendorLedgerEntry,lLevel2,pNameSpace);
      END;
    END;

    LOCAL PROCEDURE CreateBeneficiaryPersonSegment@1100281020(pServiceHeader@1100281004 : Record 5900;VAR pLevel2@1100281001 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";pPersonNo@1100281002 : Code[2];pNameSpace@1100281000 : Text[250]);
    VAR
      lContact@1000000000 : Record 5050;
      lTextBuffer@1100281003 : Text[500];
      lLevel3@1100281005 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel4@1100281006 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel5@1100281007 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel6@1100281008 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
    BEGIN
      // Segment Personne : Assur‚

      WITH EAIXMLDocMgt DO BEGIN
        // Segment Identification d'une personne
        AddElement(pLevel2,'GR050701','',pNameSpace,lLevel3);
        AddElement(lLevel3,'SE0070501','',pNameSpace,lLevel4);
        AddElement(lLevel4,'DE01390103',pPersonNo,pNameSpace,lLevel5);
        AddElement(lLevel4,'DT90720102','',pNameSpace,lLevel5);
        AddAttribute(lLevel5,'code','01');
        AddElement(lLevel4,'DCC0500103','',pNameSpace,lLevel5);
        //<<IMH07.PC
        //lTextBuffer := ReplaceSpecialChar(COPYSTR(pServiceHeader.Name,1,32));
        lContact.GET(pServiceHeader."Contact No.");
        lTextBuffer := ReplaceSpecialChar(COPYSTR(lContact.Surname + ' ' + lContact."First Name",1,32));
        //>>IMH07.PC
        AddElement(lLevel5,'DE05350101',lTextBuffer,pNameSpace,lLevel6);
        lTextBuffer := ReplaceSpecialChar(COPYSTR(pServiceHeader.Address,1,32));
        IF lTextBuffer <> '' THEN BEGIN
          AddElement(lLevel5,'DE05360101',lTextBuffer,pNameSpace,lLevel6);
        END;
        lTextBuffer := ReplaceSpecialChar(COPYSTR(pServiceHeader."Address 2",1,32));
        IF lTextBuffer <> '' THEN BEGIN
          AddElement(lLevel5,'DE05370101',lTextBuffer,pNameSpace,lLevel6);
        END;
        AddElement(lLevel5,'DE05390101',COPYSTR(pServiceHeader."Post Code",1,32),pNameSpace,lLevel6);
        lTextBuffer := ReplaceSpecialChar(COPYSTR(pServiceHeader.City,1,32));
        AddElement(lLevel5,'DE05410101',lTextBuffer,pNameSpace,lLevel6);

        // Segment Coordonnes de Telecommunication
        IF (pServiceHeader."Ship-to Phone" <> '') OR
           (pServiceHeader."Ship-to Phone 2" <> '') OR
           (pServiceHeader."Ship-to Fax No." <> '') OR
           (pServiceHeader."Ship-to Mobile Phone No." <> '')
        THEN BEGIN
          AddElement(lLevel3,'SE1600102LIST','',pNameSpace,lLevel4);
          lTextBuffer := DELCHR(pServiceHeader."Ship-to Phone",'=',' ');
          IF lTextBuffer <> '' THEN BEGIN
            AddElement(lLevel4,'SE1600102','',pNameSpace,lLevel5);
            AddElement(lLevel5,'DT92210102','',pNameSpace,lLevel6);
            AddAttribute(lLevel6,'code','1');
            AddElement(lLevel5,'DE08200102',lTextBuffer,pNameSpace,lLevel6);
          END;
          lTextBuffer := DELCHR(pServiceHeader."Ship-to Phone 2",'=',' ');
          IF lTextBuffer <> '' THEN BEGIN
            AddElement(lLevel4,'SE1600102','',pNameSpace,lLevel5);
            AddElement(lLevel5,'DT92210102','',pNameSpace,lLevel6);
            AddAttribute(lLevel6,'code','1');
            AddElement(lLevel5,'DE08200102',lTextBuffer,pNameSpace,lLevel6);
          END;
          lTextBuffer := DELCHR(pServiceHeader."Ship-to Fax No.",'=',' ');
          IF lTextBuffer <> '' THEN BEGIN
            AddElement(lLevel4,'SE1600102','',pNameSpace,lLevel5);
            AddElement(lLevel5,'DT92210102','',pNameSpace,lLevel6);
            AddAttribute(lLevel6,'code','3');
            AddElement(lLevel5,'DE08200102',lTextBuffer,pNameSpace,lLevel6);
          END;
          lTextBuffer := DELCHR(pServiceHeader."Ship-to Mobile Phone No.",'=',' ');
          IF lTextBuffer <> '' THEN BEGIN
            AddElement(lLevel4,'SE1600102','',pNameSpace,lLevel5);
            AddElement(lLevel5,'DT92210102','',pNameSpace,lLevel6);
            AddAttribute(lLevel6,'code','6');
            AddElement(lLevel5,'DE08200102',lTextBuffer,pNameSpace,lLevel6);
          END;
        END;

        // Segment Coordonnes Informatiques
        lTextBuffer := DeleteMailInvalidChar(pServiceHeader."E-Mail");
        IF lTextBuffer <> '' THEN BEGIN
          AddElement(lLevel3,'SE2010101LIST','',pNameSpace,lLevel4);
          AddElement(lLevel4,'SE2010101','',pNameSpace,lLevel5);
          AddElement(lLevel5,'DT92980101','',pNameSpace,lLevel6);
          AddAttribute(lLevel6,'code','1');
          AddElement(lLevel5,'DE09740101',lTextBuffer,pNameSpace,lLevel6);
        END;
      END;
    END;

    LOCAL PROCEDURE CreateIMHPersonSegment@1100281021(VAR pLevel2@1100281002 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";pServiceNo@1100281009 : Code[20];pPersonNo@1100281001 : Code[2];pNameSpace@1100281000 : Text[250]);
    VAR
      lCompanyInformation@1100281003 : Record 79;
      lTextBuffer@1100281007 : Text[500];
      lLevel3@1100281006 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel4@1100281005 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel5@1100281004 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel6@1100281008 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
    BEGIN
      // Segment Personne : IMH

      WITH EAIXMLDocMgt DO BEGIN
        lCompanyInformation.GET;

        // Segment Identification d'une personne
        AddElement(pLevel2,'GR050701','',pNameSpace,lLevel3);
        AddElement(lLevel3,'SE0070501','',pNameSpace,lLevel4);
        AddElement(lLevel4,'DE01390103',pPersonNo,pNameSpace,lLevel5);
        AddElement(lLevel4,'DT90720102','',pNameSpace,lLevel5);
        AddAttribute(lLevel5,'code','72');
        AddElement(lLevel4,'DCC0500103','',pNameSpace,lLevel5);
        lTextBuffer := ReplaceSpecialChar(COPYSTR(lCompanyInformation.Name,1,32));
        AddElement(lLevel5,'DE05350101',lTextBuffer,pNameSpace,lLevel6);
        lTextBuffer := ReplaceSpecialChar(COPYSTR(lCompanyInformation.Address,1,32));
        IF lTextBuffer <> '' THEN BEGIN
          AddElement(lLevel5,'DE05360101',lTextBuffer,pNameSpace,lLevel6);
        END;
        lTextBuffer := ReplaceSpecialChar(COPYSTR(lCompanyInformation."Address 2",1,32));
        IF lTextBuffer <> '' THEN BEGIN
          AddElement(lLevel5,'DE05370101',lTextBuffer,pNameSpace,lLevel6);
        END;
        AddElement(lLevel5,'DE05390101',COPYSTR(lCompanyInformation."Post Code",1,32),pNameSpace,lLevel6);
        lTextBuffer := ReplaceSpecialChar(COPYSTR(lCompanyInformation.City,1,32));
        AddElement(lLevel5,'DE05410101',lTextBuffer,pNameSpace,lLevel6);

        // Segment Coordonnes de Telecommunication
        IF (lCompanyInformation."Phone No." <> '') OR
           (lCompanyInformation."Phone No. 2" <> '') OR
           (lCompanyInformation."Fax No." <> '')
        THEN BEGIN
          AddElement(lLevel3,'SE1600102LIST','',pNameSpace,lLevel4);
          lTextBuffer := DELCHR(lCompanyInformation."Phone No.",'=',' ');
          IF lTextBuffer <> '' THEN BEGIN
            AddElement(lLevel4,'SE1600102','',pNameSpace,lLevel5);
            AddElement(lLevel5,'DT92210102','',pNameSpace,lLevel6);
            AddAttribute(lLevel6,'code','1');
            AddElement(lLevel5,'DE08200102',lTextBuffer,pNameSpace,lLevel6);
          END;
          lTextBuffer := DELCHR(lCompanyInformation."Phone No. 2",'=',' ');
          IF lTextBuffer <> '' THEN BEGIN
            AddElement(lLevel4,'SE1600102','',pNameSpace,lLevel5);
            AddElement(lLevel5,'DT92210102','',pNameSpace,lLevel6);
            AddAttribute(lLevel6,'code','1');
            AddElement(lLevel5,'DE08200102',lTextBuffer,pNameSpace,lLevel6);
          END;
          lTextBuffer := DELCHR(lCompanyInformation."Fax No.",'=',' ');
          IF lTextBuffer <> '' THEN BEGIN
            AddElement(lLevel4,'SE1600102','',pNameSpace,lLevel5);
            AddElement(lLevel5,'DT92210102','',pNameSpace,lLevel6);
            AddAttribute(lLevel6,'code','3');
            AddElement(lLevel5,'DE08200102',lTextBuffer,pNameSpace,lLevel6);
          END;
        END;

        // Segment Coordonnes Informatiques
        IF lCompanyInformation."E-Mail" <> '' THEN BEGIN
          AddElement(lLevel3,'SE2010101LIST','',pNameSpace,lLevel4);
          lTextBuffer := DeleteMailInvalidChar(lCompanyInformation."E-Mail");
          IF lTextBuffer <> '' THEN BEGIN
            AddElement(lLevel4,'SE2010101','',pNameSpace,lLevel5);
            AddElement(lLevel5,'DT92980101','',pNameSpace,lLevel6);
            AddAttribute(lLevel6,'code','1');
            AddElement(lLevel5,'DE09740101',lTextBuffer,pNameSpace,lLevel6);
          END;
        END;

        // Segment Reference - Nø service
        AddElement(lLevel3,'SE1620101LIST','',pNameSpace,lLevel4);
        AddElement(lLevel4,'SE1620101','',pNameSpace,lLevel5);
        AddElement(lLevel5,'DT92240101','',pNameSpace,lLevel6);
        AddAttribute(lLevel6,'code','16');
        lTextBuffer := pServiceNo;
        AddElement(lLevel5,'DE08210101',lTextBuffer,pNameSpace,lLevel6);
      END;
    END;

    LOCAL PROCEDURE CreateExpertPersonSegment@1100281022(pServiceHeader@1100281003 : Record 5900;VAR pLevel2@1100281002 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";pPersonNo@1100281001 : Code[2];pNameSpace@1100281000 : Text[250]);
    VAR
      lContact@1100281008 : Record 5050;
      lTextBuffer@1100281007 : Text[500];
      lLevel3@1100281006 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel4@1100281005 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel5@1100281004 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel6@1100281009 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
    BEGIN
      // Segment Personne : Expert

      WITH EAIXMLDocMgt DO BEGIN
        IF NOT lContact.GET(pServiceHeader."Expert Contact No.") THEN BEGIN
          EXIT;
        END;
        // Segment Identification d'une personne
        AddElement(pLevel2,'GR050701','',pNameSpace,lLevel3);
        AddElement(lLevel3,'SE0070501','',pNameSpace,lLevel4);
        AddElement(lLevel4,'DE01390103',pPersonNo,pNameSpace,lLevel5);
        AddElement(lLevel4,'DT90720102','',pNameSpace,lLevel5);
        AddAttribute(lLevel5,'code','52');
        AddElement(lLevel4,'DCC0500103','',pNameSpace,lLevel5);
        lTextBuffer := ReplaceSpecialChar(COPYSTR(lContact.Name,1,32));
        AddElement(lLevel5,'DE05350101',lTextBuffer,pNameSpace,lLevel6);
        lTextBuffer := ReplaceSpecialChar(COPYSTR(lContact.Address,1,32));
        IF lTextBuffer <> '' THEN BEGIN
          AddElement(lLevel5,'DE05360101',lTextBuffer,pNameSpace,lLevel6);
        END;
        lTextBuffer := ReplaceSpecialChar(COPYSTR(lContact."Address 2",1,32));
        IF lTextBuffer <> '' THEN BEGIN
          AddElement(lLevel5,'DE05370101',lTextBuffer,pNameSpace,lLevel6);
        END;
        AddElement(lLevel5,'DE05390101',COPYSTR(lContact."Post Code",1,32),pNameSpace,lLevel6);
        lTextBuffer := ReplaceSpecialChar(COPYSTR(lContact.City,1,32));
        AddElement(lLevel5,'DE05410101',lTextBuffer,pNameSpace,lLevel6);

        // Segment Coordonnes de Telecommunication
        IF (lContact."Phone No." <> '') OR
           (lContact."Phone No. 2" <> '') OR
           (lContact."Fax No." <> '') OR
           (lContact."Mobile Phone No." <> '')
        THEN BEGIN
          AddElement(lLevel3,'SE1600102LIST','',pNameSpace,lLevel4);
          lTextBuffer := DELCHR(lContact."Phone No.",'=',' ');
          IF lTextBuffer <> '' THEN BEGIN
            AddElement(lLevel4,'SE1600102','',pNameSpace,lLevel5);
            AddElement(lLevel5,'DT92210102','',pNameSpace,lLevel6);
            AddAttribute(lLevel6,'code','1');
            AddElement(lLevel5,'DE08200102',lTextBuffer,pNameSpace,lLevel6);
          END;
          lTextBuffer := DELCHR(lContact."Phone No. 2",'=',' ');
          IF lTextBuffer <> '' THEN BEGIN
            AddElement(lLevel4,'SE1600102','',pNameSpace,lLevel5);
            AddElement(lLevel5,'DT92210102','',pNameSpace,lLevel6);
            AddAttribute(lLevel6,'code','1');
            AddElement(lLevel5,'DE08200102',lTextBuffer,pNameSpace,lLevel6);
          END;
          lTextBuffer := DELCHR(lContact."Fax No.",'=',' ');
          IF lTextBuffer <> '' THEN BEGIN
            AddElement(lLevel4,'SE1600102','',pNameSpace,lLevel5);
            AddElement(lLevel5,'DT92210102','',pNameSpace,lLevel6);
            AddAttribute(lLevel6,'code','3');
            AddElement(lLevel5,'DE08200102',lTextBuffer,pNameSpace,lLevel6);
          END;
          lTextBuffer := DELCHR(lContact."Mobile Phone No.",'=',' ');
          IF lTextBuffer <> '' THEN BEGIN
            AddElement(lLevel4,'SE1600102','',pNameSpace,lLevel5);
            AddElement(lLevel5,'DT92210102','',pNameSpace,lLevel6);
            AddAttribute(lLevel6,'code','6');
            AddElement(lLevel5,'DE08200102',lTextBuffer,pNameSpace,lLevel6);
          END;
        END;

        // Segment Coordonnes Informatiques
        IF lContact."E-Mail" <> '' THEN BEGIN
          AddElement(lLevel3,'SE2010101LIST','',pNameSpace,lLevel4);
          lTextBuffer := DeleteMailInvalidChar(lContact."E-Mail");
          IF lTextBuffer <> '' THEN BEGIN
            AddElement(lLevel4,'SE2010101','',pNameSpace,lLevel5);
            AddElement(lLevel5,'DT92980101','',pNameSpace,lLevel6);
            AddAttribute(lLevel6,'code','1');
            AddElement(lLevel5,'DE09740101',lTextBuffer,pNameSpace,lLevel6);
          END;
        END;

        // Segment Reference
        IF (pServiceHeader."Expert Ref." <> '') THEN BEGIN
          AddElement(lLevel3,'SE1620101LIST','',pNameSpace,lLevel4);
          AddElement(lLevel4,'SE1620101','',pNameSpace,lLevel5);
          AddElement(lLevel5,'DT92240101','',pNameSpace,lLevel6);
          AddAttribute(lLevel6,'code','09');
          lTextBuffer := pServiceHeader."Expert Ref.";
          AddElement(lLevel5,'DE08210101',lTextBuffer,pNameSpace,lLevel6);
        END;
      END;
    END;

    LOCAL PROCEDURE CreateProviderPersonSegment@1100281023(pServiceHeader@1100281010 : Record 5900;pVendorLedgerEntry@1100281003 : Record 25;VAR pLevel2@1100281002 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";pNameSpace@1100281000 : Text[250]);
    VAR
      lProvider@1100281008 : Record 50000;
      lDARVASetup@1000000000 : Record 50126;
      lServiceInterventionLine@1100281012 : Record 50075;
      lLevel3@1100281006 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel4@1100281005 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel5@1100281004 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel6@1100281011 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lTextBuffer@1100281009 : Text[500];
      lAgreementCode@1100281007 : Code[10];
      lNumPartie@1000000001 : Text[1024];
    BEGIN
      // Segment Personne : IMH

      WITH EAIXMLDocMgt DO BEGIN
        //<<IMH04.PC
        //lProvider.GET(pVendorLedgerEntry."Vendor No.");
        lServiceInterventionLine.GET(pVendorLedgerEntry."Service Header No.",pVendorLedgerEntry."Intervention Line No.");
        lProvider.GET(lServiceInterventionLine."Provider No.");
        //>>IMH04.PC
        //<<IMH05.PC
        //lInterfaceReference.SETRANGE("Source Table ID",DATABASE::"Service Intervention Line");
        //lInterfaceReference.SETRANGE("Source No.",pVendorLedgerEntry."Service No.");
        //lInterfaceReference.SETRANGE("Source No. 2",pVendorLedgerEntry."Service Header No.");
        //lInterfaceReference.SETRANGE("Source No. 3",pVendorLedgerEntry."Intervention Line No.");
        //lInterfaceReference.FINDFIRST;
        lNumPartie := GetNumPartie(pVendorLedgerEntry);
        //>>IMH05.PC

        // Segment Identification d'une personne
        AddElement(pLevel2,'GR050701','',pNameSpace,lLevel3);
        AddElement(lLevel3,'SE0070501','',pNameSpace,lLevel4);
        //<<IMH05.PC
        IF lNumPartie <> '' THEN BEGIN
        //>>IMH05.PC
          AddElement(lLevel4,'DE01390103',lNumPartie,pNameSpace,lLevel5);
        END;
        AddElement(lLevel4,'DT90720102','',pNameSpace,lLevel5);
        AddAttribute(lLevel5,'code','29');
        AddElement(lLevel4,'DCC0500103','',pNameSpace,lLevel5);
        lTextBuffer := ReplaceSpecialChar(COPYSTR(lProvider.Name,1,32));
        AddElement(lLevel5,'DE05350101',lTextBuffer,pNameSpace,lLevel6);
        IF lProvider.Address <> '' THEN BEGIN
          lTextBuffer := ReplaceSpecialChar(COPYSTR(lProvider.Address,1,32));
          AddElement(lLevel5,'DE05360101',lTextBuffer,pNameSpace,lLevel6);
        END;
        IF lProvider."Address 2" <> '' THEN BEGIN
          lTextBuffer := ReplaceSpecialChar(COPYSTR(lProvider."Address 2",1,32));
          AddElement(lLevel5,'DE05370101',lTextBuffer,pNameSpace,lLevel6);
        END;
        AddElement(lLevel5,'DE05390101',COPYSTR(lProvider."Post Code",1,32),pNameSpace,lLevel6);
        lTextBuffer := ReplaceSpecialChar(COPYSTR(lProvider.City,1,32));
        AddElement(lLevel5,'DE05410101',lTextBuffer,pNameSpace,lLevel6);
        AddElement(lLevel4,'DT92050103','',pNameSpace,lLevel5);
        //<<IMH12.ACO
        //IF lProvider."VAT Registration No." = '' THEN BEGIN
        //  AddAttribute(lLevel5,'code','2');
        //END ELSE BEGIN
        //>>IMH12.ACO
          AddAttribute(lLevel5,'code','1');
        //<<IMH12.ACO
        //END;
        //>>IMH12.ACO

        // Segment Coordonnes de Telecommunication
        IF (lProvider."Phone No." <> '') OR
           (lProvider."Business Phone No." <> '') OR
           (lProvider."Mobile Phone No." <> '') OR
           (lProvider."Fax No." <> '')
        THEN BEGIN
          AddElement(lLevel3,'SE1600102LIST','',pNameSpace,lLevel4);
          lTextBuffer := DELCHR(lProvider."Phone No.",'=',' ');
          IF lTextBuffer <> '' THEN BEGIN
            AddElement(lLevel4,'SE1600102','',pNameSpace,lLevel5);
            AddElement(lLevel5,'DT92210102','',pNameSpace,lLevel6);
            AddAttribute(lLevel6,'code','1');
            AddElement(lLevel5,'DE08200102',lTextBuffer,pNameSpace,lLevel6);
          END;
          lTextBuffer := DELCHR(lProvider."Business Phone No.",'=',' ');
          IF lTextBuffer <> '' THEN BEGIN
            AddElement(lLevel4,'SE1600102','',pNameSpace,lLevel5);
            AddElement(lLevel5,'DT92210102','',pNameSpace,lLevel6);
            AddAttribute(lLevel6,'code','1');
            AddElement(lLevel5,'DE08200102',lTextBuffer,pNameSpace,lLevel6);
          END;
          lTextBuffer := DELCHR(lProvider."Mobile Phone No.",'=',' ');
          IF (lTextBuffer <> '') THEN BEGIN
            AddElement(lLevel4,'SE1600102','',pNameSpace,lLevel5);
            AddElement(lLevel5,'DT92210102','',pNameSpace,lLevel6);
            AddAttribute(lLevel6,'code','6');
            AddElement(lLevel5,'DE08200102',lTextBuffer,pNameSpace,lLevel6);
          END;
          lTextBuffer := DELCHR(lProvider."Fax No.",'=',' ');
          IF (lTextBuffer <> '') THEN BEGIN
            AddElement(lLevel4,'SE1600102','',pNameSpace,lLevel5);
            AddElement(lLevel5,'DT92210102','',pNameSpace,lLevel6);
            AddAttribute(lLevel6,'code','3');
            AddElement(lLevel5,'DE08200102',lTextBuffer,pNameSpace,lLevel6);
          END;
        END;

        // Segment Coordonnes Informatiques
        lTextBuffer := DeleteMailInvalidChar(lProvider."E-Mail");
        IF lTextBuffer <> '' THEN BEGIN
          AddElement(lLevel3,'SE2010101LIST','',pNameSpace,lLevel4);
          AddElement(lLevel4,'SE2010101','',pNameSpace,lLevel5);
          AddElement(lLevel5,'DT92980101','',pNameSpace,lLevel6);
          AddAttribute(lLevel6,'code','1');
          AddElement(lLevel5,'DE09740101',lTextBuffer,pNameSpace,lLevel6);
        END;

        // Segment Reference
        lAgreementCode :=
          lProvider.GetAgreement(
            pServiceHeader."Corporate No.",
            pServiceHeader."Corporate Region Code",
            pServiceHeader."Service Order Type");

        IF (lAgreementCode = lProvider."No.") OR (lAgreementCode = '') THEN BEGIN
          lDARVASetup.GET;
          lAgreementCode := lDARVASetup."Default MATMUT Prov. Agreement";
        END;
        AddElement(lLevel3,'SE1620101LIST','',pNameSpace,lLevel4);
        AddElement(lLevel4,'SE1620101','',pNameSpace,lLevel5);
        AddElement(lLevel5,'DT92240101','',pNameSpace,lLevel6);
        AddAttribute(lLevel6,'code','08');
        lTextBuffer := lAgreementCode;
        AddElement(lLevel5,'DE08210101',lTextBuffer,pNameSpace,lLevel6);

        AddElement(lLevel4,'SE1620101','',pNameSpace,lLevel5);
        AddElement(lLevel5,'DT92240101','',pNameSpace,lLevel6);
        AddAttribute(lLevel6,'code','27');
        lTextBuffer := lProvider."No.";
        AddElement(lLevel5,'DE08210101',lTextBuffer,pNameSpace,lLevel6);
      END;
    END;

    LOCAL PROCEDURE CreatePaymentDoneSegment@1100281028(pVendorLedgerEntry@1100281003 : Record 25;VAR pLevel1@1100281002 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";pNameSpace@1100281000 : Text[250]);
    VAR
      lProvider@1100281008 : Record 50000;
      lServiceInterventionLine@1000000001 : Record 50075;
      lLevel2@1100281005 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel3@1100281004 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lAmountExclVAT@1100281007 : Decimal;
      lAmountVAT@1100281006 : Decimal;
      lPercentVAT@1100281001 : Decimal;
      lAmountText@1000000000 : Text[9];
    BEGIN
      // Segment Reglement Effectue

      WITH EAIXMLDocMgt DO BEGIN
        //<<IMH04.PC
        //lProvider.GET(pVendorLedgerEntry."Vendor No.");
        lServiceInterventionLine.GET(pVendorLedgerEntry."Service Header No.",pVendorLedgerEntry."Intervention Line No.");
        lProvider.GET(lServiceInterventionLine."Provider No.");
        //>>IMH04.PC
        GetAmounts(pVendorLedgerEntry,lAmountExclVAT,lAmountVAT,lPercentVAT);
        AddElement(pLevel1,'SE0540501','',pNameSpace,lLevel2);
        // Mnt Charge Soc Assurance
        //<<IMH12.ACO
        //<<IMH09.PC
        {//IF lProvider."VAT Registration No." = '' THEN BEGIN
        IF lProvider."VAT Registration No." <> '' THEN BEGIN
        //>>IMH09.PC
          lAmountText := FORMAT(lAmountExclVAT,0,9);
        END ELSE BEGIN}
        //>>IMH12.ACO
          lAmountText := FORMAT(lAmountExclVAT + lAmountVAT,0,9);
        //<<IMH12.ACO
        //END;
        //>>IMH12.ACO
        WHILE STRLEN(lAmountText) < 9 DO BEGIN
          lAmountText := '0' + lAmountText;
        END;
        AddElement(lLevel2,'DE04130101',lAmountText,pNameSpace,lLevel3);
      END;
    END;

    LOCAL PROCEDURE CreateWorkPaymentGroup@1100281029(pVendorLedgerEntry@1100281002 : Record 25;VAR pLevel1@1100281001 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";pEAIPartnerCode@1100281016 : Code[20];pNameSpace@1100281000 : Text[250]);
    VAR
      lProvider@1100281006 : Record 50000;
      lInterventionDescription@1100281011 : Record 50070;
      lEAIPartnerCrossReference@1100281014 : Record 8016748;
      lServiceInterventionLine@1000000000 : Record 50075;
      lLevel2@1100281004 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel3@1100281003 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel4@1100281005 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel5@1100281012 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel6@1100281013 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lAmountExclVAT@1100281009 : Decimal;
      lAmountVAT@1100281008 : Decimal;
      lPercentVAT@1100281007 : Decimal;
      lTextBuffer@1100281015 : Text[500];
      lNumPartie@1000000001 : Text[1024];
      lBuildingTrade@1000000002 : Record 50032;
      lToolsMgt@1000000003 : Codeunit 8016602;
      lText@1000000004 : Text[1024];
    BEGIN
      // Groupe Reglement des travaux

      WITH EAIXMLDocMgt DO BEGIN
        //<<IMH04.PC
        //lProvider.GET(pVendorLedgerEntry."Vendor No.");
        lServiceInterventionLine.GET(pVendorLedgerEntry."Service Header No.",pVendorLedgerEntry."Intervention Line No.");
        lProvider.GET(lServiceInterventionLine."Provider No.");
        //>>IMH04.PC
        //<<IMH05.PC
        //lInterfaceReference.SETRANGE("Source Table ID",DATABASE::"Service Intervention Line");
        //lInterfaceReference.SETRANGE("Source No.",pVendorLedgerEntry."Service No.");
        //lInterfaceReference.SETRANGE("Source No. 2",pVendorLedgerEntry."Service Header No.");
        //lInterfaceReference.SETRANGE("Source No. 3",pVendorLedgerEntry."Intervention Line No.");
        //lInterfaceReference.FINDFIRST;
        lNumPartie := GetNumPartie(pVendorLedgerEntry);
        //>>IMH05.PC

        AddElement(pLevel1,'GR060701LIST','',pNameSpace,lLevel2);
        AddElement(lLevel2,'GR060701','',pNameSpace,lLevel3);
        // - Perimetre de la prestation
        AddElement(lLevel3,'SE2650101','',pNameSpace,lLevel4);
        //<<IMH05.PC
        IF lNumPartie <> '' THEN BEGIN
        //>>IMH05.pC
          AddElement(lLevel4,'DE01390103',lNumPartie,pNameSpace,lLevel5);
        END;

        // - Identificationdu prestataire
        AddElement(lLevel3,'SE0930301','',pNameSpace,lLevel4);
        //<<IMH06.PC
        //AddElement(lLevel4,'DE04040102',lProvider."Registration No.",pNameSpace,lLevel5);
        //<<IMH08.PC
        //IF STRLEN(lProvider."Registration No.") <> 14 THEN BEGIN
        IF STRLEN(lProvider."Registration No.") = 14 THEN BEGIN
        //>>IMH08.PC
          AddElement(lLevel4,'DE04040102',lProvider."Registration No.",pNameSpace,lLevel5);
        END ELSE BEGIN
          AddElement(lLevel4,'DE04040102','99999999999999',pNameSpace,lLevel5);
        END;
        //>>IMH06.PC
        AddElement(lLevel4,'DT90940101','',pNameSpace,lLevel5);
        AddAttribute(lLevel5,'code','99');
        AddElement(lLevel4,'DT90950101','',pNameSpace,lLevel5);
        AddAttribute(lLevel5,'code','0');
        AddElement(lLevel4,'DE02280102','N',pNameSpace,lLevel5);
        AddElement(lLevel4,'DE02290102','9999',pNameSpace,lLevel5);
        //<<IMH06.PC
        //AddElement(lLevel4,'DE02300101',lProvider."VAT Registration No.",pNameSpace,lLevel5);
        //<<IMH08.PC
        //IF STRLEN(lProvider."VAT Registration No.") <> 13 THEN BEGIN
        IF STRLEN(lProvider."VAT Registration No.") = 13 THEN BEGIN
        //>>IMH08.PC
          AddElement(lLevel4,'DE02300101',lProvider."VAT Registration No.",pNameSpace,lLevel5);
        END ELSE BEGIN
          AddElement(lLevel4,'DE02300101','9999999999999',pNameSpace,lLevel5);
        END;
        //>>IMH06.PC

        // - Reglement de la prestation
        AddElement(lLevel3,'SE2680101','',pNameSpace,lLevel4);
        AddElement(lLevel4,'DT93100101','',pNameSpace,lLevel5);
        AddAttribute(lLevel5,'code','1');
        AddElement(lLevel4,'DT94070101','',pNameSpace,lLevel5);
        AddAttribute(lLevel5,'code','0');

        // - Descriptif des travaux
        lInterventionDescription.SETRANGE("Service Header No.",pVendorLedgerEntry."Service Header No.");
        lInterventionDescription.SETFILTER("Intervention Line No. Filter",FORMAT(pVendorLedgerEntry."Intervention Line No."));
        lInterventionDescription.SETRANGE("Intervention Speciality",TRUE);
        IF lInterventionDescription.FINDSET THEN BEGIN
          AddElement(lLevel3,'SE2060101LIST','',pNameSpace,lLevel4);
          REPEAT
            AddElement(lLevel4,'SE2060101','',pNameSpace,lLevel5);
            lTextBuffer := lInterventionDescription."Location Detail Description";
            IF lTextBuffer = '' THEN BEGIN
              lTextBuffer := lInterventionDescription."Affected Location Description";
            END;
            AddElement(lLevel5,'DE14570101',ReplaceSpecialChar(COPYSTR(lTextBuffer,1,20)),pNameSpace,lLevel6);
            IF lEAIPartnerCrossReference.GetToCrossRef(
                 DATABASE::"Building Trade",0,pEAIPartnerCode,
                 lInterventionDescription."Building Trade No.",lEAIPartnerCrossReference)
            THEN BEGIN
              AddElement(lLevel5,'DT90790101','',pNameSpace,lLevel6);
              AddAttribute(lLevel6,'code',lEAIPartnerCrossReference."Partner Reference");
            END;
            //<<IMH13.ACO
            IF lEAIPartnerCrossReference.GetToCrossRef(
                 DATABASE::"Building Trade",50612,pEAIPartnerCode,
                 lInterventionDescription."Building Trade No.",lEAIPartnerCrossReference)
            THEN BEGIN
              AddElement(lLevel5,'DT90800102','',pNameSpace,lLevel6);
              AddAttribute(lLevel6,'code',lEAIPartnerCrossReference."Partner Reference");
            END;

            IF lEAIPartnerCrossReference.GetToCrossRef(
                 DATABASE::"Building Trade",50613,pEAIPartnerCode,
                 lInterventionDescription."Building Trade No.",lEAIPartnerCrossReference)
            THEN BEGIN
              AddElement(lLevel5,
                          'DE01520101',
                          CodeDesc.GetDescription(50032,50613,lEAIPartnerCrossReference."Partner Reference"),
                          pNameSpace,
                          lLevel6);
            END;

            //>>IMH13.ACO
          UNTIL lInterventionDescription.NEXT = 0;
        END;
      END;
    END;

    LOCAL PROCEDURE CheckDRT@1000000007(pVendorLedgerEntry@1000000002 : Record 25;VAR pDocumentAttachment@1100281008 : Record 50021);
    VAR
      lServiceHeader@1000000000 : Record 5900;
      lServiceInterventionLine@1000000018 : Record 50075;
      lDARVASetup@1100281000 : Record 50126;
      lDARVADTStorage@1100281004 : Record 50124;
      lInteractionTemplate@1100281002 : Record 5064;
      lCustomer@1100281003 : Record 18;
      lProvider@1000000009 : Record 50000;
      lLastStorageEntryNo@1100281005 : Integer;
      lTextBuffer@1000000001 : Text[1024];
      lText001@1000000003 : TextConst 'ENU=DARVA Setup empty : %1;FRA=ParamŠtre DARVA non fait : %1';
      lText002@1000000004 : TextConst 'ENU=SDR64 not send;FRA="Un SDR64 n''a pas ‚t‚ pr‚alablement ‚mis pour ce Prestataire pour cette mission. "';
      lText003@1000000005 : TextConst 'ENU=SDR64 return;FRA=retour SDR64';
      lText004@1000000006 : TextConst 'ENU=DT datas empty;FRA=donn‚es DT';
      lText005@1000000007 : TextConst 'ENU=DT data %1 empty;FRA=donn‚e DT %1';
      lParentTagEntryNo@1000000008 : Integer;
      lText006@1000000010 : TextConst 'ENU=provider;FRA=prestataire';
      lText007@1000000011 : TextConst 'ENU=provider address;FRA=adresse prestataire';
      lText008@1000000012 : TextConst 'ENU=fusion reference;FRA=r‚f‚rence fusion';
      lText009@1000000013 : TextConst 'ENU=registration;FRA=SIRET';
      lText010@1000000019 : TextConst 'ENU=DRT send is impossible because %1 missing;FRA="L''‚mission de la DRT est impossible : la donn‚e %1 est manquante "';
      lText011@1000000020 : TextConst 'ENU=VAT registration;FRA=TVA intracom.';
      lText100@1000000014 : TextConst 'ENU=Service header %1 do not exists;FRA=Impossible de trouver la ligne produit %1';
      lParamNb@1000000017 : Integer;
      lShowMessage@1000000016 : Boolean;
      lReturnValue@1000000015 : Boolean;
      lNumPartie@1000000021 : Text[1024];
      lPurchInvHeader@1000000022 : Record 122;
    BEGIN

      IF NOT lServiceHeader.GET(lServiceHeader."Document Type"::Invoice,pVendorLedgerEntry."Service Header No.") THEN BEGIN
        ERROR(lText100,pVendorLedgerEntry."Service Header No.");
      END;

      IF NOT lServiceHeader."DARVA Interface" THEN BEGIN
        EXIT;
      END;

      lDARVASetup.GET;
      lDARVASetup.TESTFIELD("DRT Inv. Inter. Temp. Code");
      IF NOT lInteractionTemplate.GET(lDARVASetup."DRT Inv. Inter. Temp. Code") THEN BEGIN
        ERROR(lText001,lDARVASetup.FIELDCAPTION("DRT Inv. Inter. Temp. Code"));
      END;
      IF lDARVASetup."Default MATMUT Prov. Agreement" = '' THEN BEGIN
        ERROR(lText001,lDARVASetup.FIELDCAPTION("Default MATMUT Prov. Agreement"));
      END;
      IF NOT lCustomer.GET(lDARVASetup."MATMUT Corporate No.") THEN BEGIN
        ERROR(lText001,lDARVASetup.FIELDCAPTION("MATMUT Corporate No."));
      END;
      IF NOT lCustomer.GET(lDARVASetup."AMF Corporate No.") THEN BEGIN
        ERROR(lText001,lDARVASetup.FIELDCAPTION("AMF Corporate No."));
      END;

      IF (pVendorLedgerEntry."Corporate No." <> lDARVASetup."MATMUT Corporate No.") AND
         (pVendorLedgerEntry."Corporate No." <> lDARVASetup."AMF Corporate No.")
      THEN BEGIN
        EXIT;
      END;

      // SDR64 envoy‚
      lServiceHeader.CALCFIELDS("SDR64 Send");
      IF NOT lServiceHeader."SDR64 Send" THEN BEGIN
        ERROR(lText002);
      END;

      lServiceInterventionLine.GET(pVendorLedgerEntry."Service Header No.",pVendorLedgerEntry."Intervention Line No.");
      IF NOT lProvider.GET(lServiceInterventionLine."Provider No.") THEN BEGIN
        ERROR(STRSUBSTNO(lText010,lText006));
      END;

      // Numero partie recu en retour de SDR64
      //<<IMH05.PC
      //lInterfaceReference.SETRANGE("Source Table ID",DATABASE::"Service Intervention Line");
      //lInterfaceReference.SETRANGE("Source No.",pVendorLedgerEntry."Service No.");
      //lInterfaceReference.SETRANGE("Source No. 2",pVendorLedgerEntry."Service Header No.");
      //lInterfaceReference.SETRANGE("Source No. 3",pVendorLedgerEntry."Intervention Line No.");
      //IF NOT lInterfaceReference.FINDFIRST THEN BEGIN
      //  ERROR(STRSUBSTNO(lText010,lText003));
      //END;
      lNumPartie := GetNumPartie(pVendorLedgerEntry);
      IF lNumPartie = '' THEN BEGIN
        ERROR(STRSUBSTNO(lText010,lText003));
      END;
      //>>IMH05.PC

      //<<IMH06.PC
      {
      // Nø dossier fusion
      IF lServiceHeader."Expert Ref." = '' THEN BEGIN
        ERROR(STRSUBSTNO(lText010,lText008));
      END;
      }
      //>>IMH06.PC

      lDARVADTStorage.RESET;
      lDARVADTStorage.SETRANGE("Service No.",pVendorLedgerEntry."Service No.");
      lDARVADTStorage.SETRANGE("Service Header No.",pVendorLedgerEntry."Service Header No.");
      IF NOT lDARVADTStorage.FINDLAST THEN BEGIN
        ERROR(STRSUBSTNO(lText010,lText004));
      END;
      lLastStorageEntryNo := lDARVADTStorage."Entry No.";

      lDARVADTStorage.SETRANGE("Tag Type",lDARVADTStorage."Tag Type"::Tag);
      lDARVADTStorage.SETRANGE("Entry No.",lLastStorageEntryNo);

      // DE00440101
      lDARVADTStorage.SETRANGE("Tag Description",'DE00440101');
      IF NOT lDARVADTStorage.FINDFIRST THEN BEGIN
        ERROR(STRSUBSTNO(lText010,STRSUBSTNO(lText005,'DE00440101')));
      END;
      lTextBuffer :=
        lDARVADTStorage."Value 1" + lDARVADTStorage."Value 2" + lDARVADTStorage."Value 3" +
        lDARVADTStorage."Value 4" + lDARVADTStorage."Value 5";
      IF lTextBuffer = '' THEN BEGIN
        ERROR(STRSUBSTNO(lText010,STRSUBSTNO(lText005,'DE00440101')));
      END;

      // GR010101
      lDARVADTStorage.SETRANGE("Tag Description",'GR010101');
      IF NOT lDARVADTStorage.FINDFIRST THEN BEGIN
        ERROR(STRSUBSTNO(lText010,STRSUBSTNO(lText005,'GR010101')));
      END ELSE BEGIN
        lParentTagEntryNo := lDARVADTStorage."Tag Entry No.";
        lDARVADTStorage.SETRANGE("Parent Tag Entry No.",lParentTagEntryNo);
      END;

      // SE0020101
      lDARVADTStorage.SETRANGE("Tag Description",'SE0020101');
      IF NOT lDARVADTStorage.FINDFIRST THEN BEGIN
        ERROR(STRSUBSTNO(lText010,STRSUBSTNO(lText005,'SE0020101')));
      END;

      // SE0030401
      lDARVADTStorage.SETRANGE("Tag Description",'SE0030401');
      IF NOT lDARVADTStorage.FINDFIRST THEN BEGIN
        ERROR(STRSUBSTNO(lText010,STRSUBSTNO(lText005,'SE0030401')));
      END;

      // SE1600102LIST
      lDARVADTStorage.SETRANGE("Tag Description",'SE1600102LIST');
      IF NOT lDARVADTStorage.FINDFIRST THEN BEGIN
        ERROR(STRSUBSTNO(lText010,STRSUBSTNO(lText005,'SE1600102LIST')));
      END;

      IF (lProvider.Name = '') AND ((lProvider.Address = '') OR
         (lProvider."Address 2" = '')) AND (lProvider."Post Code" = '') AND
         (lProvider.City = '')
      THEN BEGIN
        ERROR(STRSUBSTNO(lText010,lText007));
      END;

      //<<IMH06.PC
      {
      IF lProvider."VAT Registration No." = '' THEN BEGIN
        ERROR(STRSUBSTNO(lText010,lText011));
      END;
      IF STRLEN(lProvider."Registration No.") <> 14 THEN BEGIN
        ERROR(STRSUBSTNO(lText010,lText009));
      END;
      }
      //>>IMH06.PC

      //<<IMH11.ACO
      {pDocumentAttachment.SETCURRENTKEY(
        "Service No.","Service Document No.",
        "Service Intervention Line No.","Intervention Quote Line No.","Creation Date");
      pDocumentAttachment.SETRANGE("Service No.",pVendorLedgerEntry."Service No.");
      pDocumentAttachment.SETRANGE("Service Document No.",pVendorLedgerEntry."Service Header No.");
      pDocumentAttachment.SETRANGE("Service Intervention Line No.",pVendorLedgerEntry."Intervention Line No.");
      pDocumentAttachment.SETRANGE(Deleted,FALSE);
      pDocumentAttachment.SETRANGE("Interaction Template Code",lDARVASetup."DRT Inv. Inter. Temp. Code");
      IF NOT pDocumentAttachment.FINDFIRST THEN BEGIN
        pDocumentAttachment.SETRANGE("Interaction Template Code");
        pDocumentAttachment.SETRANGE("Queue Type",pDocumentAttachment."Queue Type"::Receipt);
        pDocumentAttachment.SETRANGE("Document Queue Type",pDocumentAttachment."Document Queue Type"::Invoice);
        IF NOT pDocumentAttachment.FINDFIRST THEN BEGIN
          ERROR(Text005);
        END;
      END;
      }

      //R‚cup‚ration de la facture achat enregistr‚e
      IF NOT lPurchInvHeader.GET(pVendorLedgerEntry."Document No.") THEN
        ERROR(Text005);

      //R‚cup‚ration de la piŠce jointe associ‚e
      pDocumentAttachment.SETRANGE("Referent Table No.",DATABASE::"Interaction Log Entry");
      pDocumentAttachment.SETRANGE("Key Integer 1",lPurchInvHeader."Interaction Log Entry No.");
      IF NOT pDocumentAttachment.FINDFIRST THEN
        ERROR(Text005);

      //>>IMH11.ACO

      IF pDocumentAttachment."GUID Fusion Code" = '' THEN BEGIN
        pDocumentAttachment."GUID Fusion Code" := FORMAT(CREATEGUID);
        pDocumentAttachment.MODIFY;
      END;
    END;

    LOCAL PROCEDURE GetDTStorage@1100281004(VAR pXMLNode@1100281000 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";pLastStorageEntryNo@1100281005 : Integer;pServiceNo@1100281002 : Code[20];pServiceHeaderNo@1100281003 : Code[20];pNameSpace@1100281008 : Text[250];pStartTagNo@1000000000 : Integer);
    VAR
      lDARVADTStorage@1100281004 : Record 50124;
      lDARVADTStorage2@1100281006 : Record 50124;
      lDARVADTStorage3@1100281015 : Record 50124;
      lDARVADTStorage4@1100281016 : Record 50124;
      lDARVADTStorage5@1100281017 : Record 50124;
      lXMLNode@1100281014 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel1@1100281007 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel2@1100281001 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel3@1100281010 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel4@1100281011 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lLevel5@1100281012 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode";
      lTextBuffer@1100281013 : Text[1024];
    BEGIN
      lDARVADTStorage.SETRANGE("Service No.",pServiceNo);
      lDARVADTStorage.SETRANGE("Service Header No.",pServiceHeaderNo);
      lDARVADTStorage.SETRANGE("Entry No.",pLastStorageEntryNo);
      lDARVADTStorage.SETRANGE("Parent Tag Entry No.",pStartTagNo);
      IF lDARVADTStorage.FINDSET THEN BEGIN
        REPEAT
          lTextBuffer :=
            lDARVADTStorage."Value 1" + lDARVADTStorage."Value 2" + lDARVADTStorage."Value 3" +
            lDARVADTStorage."Value 4" + lDARVADTStorage."Value 5";
          CASE lDARVADTStorage."Tag Type" OF
            lDARVADTStorage."Tag Type"::Tag : BEGIN
              EAIXMLDocMgt.AddElement(pXMLNode,lDARVADTStorage."Tag Description",lTextBuffer,pNameSpace,lLevel1);

              lDARVADTStorage2.SETRANGE("Service No.",pServiceNo);
              lDARVADTStorage2.SETRANGE("Service Header No.",pServiceHeaderNo);
              lDARVADTStorage2.SETRANGE("Entry No.",pLastStorageEntryNo);
              lDARVADTStorage2.SETRANGE("Parent Tag Entry No.",lDARVADTStorage."Tag Entry No.");
              IF lDARVADTStorage2.FINDSET THEN BEGIN
                REPEAT
                  // ProblŠme de r‚cursivit‚ => mise … plat
                  lTextBuffer :=
                    lDARVADTStorage2."Value 1" + lDARVADTStorage2."Value 2" + lDARVADTStorage2."Value 3" +
                    lDARVADTStorage2."Value 4" + lDARVADTStorage2."Value 5";
                  CASE lDARVADTStorage2."Tag Type" OF
                    lDARVADTStorage2."Tag Type"::Tag : BEGIN
                      EAIXMLDocMgt.AddElement(lLevel1,lDARVADTStorage2."Tag Description",lTextBuffer,pNameSpace,lLevel2);

                      lDARVADTStorage3.SETRANGE("Service No.",pServiceNo);
                      lDARVADTStorage3.SETRANGE("Service Header No.",pServiceHeaderNo);
                      lDARVADTStorage3.SETRANGE("Entry No.",pLastStorageEntryNo);
                      lDARVADTStorage3.SETRANGE("Parent Tag Entry No.",lDARVADTStorage2."Tag Entry No.");
                      IF lDARVADTStorage3.FINDSET THEN BEGIN
                        REPEAT
                          lTextBuffer :=
                            lDARVADTStorage3."Value 1" + lDARVADTStorage3."Value 2" + lDARVADTStorage3."Value 3" +
                            lDARVADTStorage3."Value 4" + lDARVADTStorage3."Value 5";
                          CASE lDARVADTStorage3."Tag Type" OF
                            lDARVADTStorage3."Tag Type"::Tag : BEGIN
                              EAIXMLDocMgt.AddElement(lLevel2,lDARVADTStorage3."Tag Description",lTextBuffer,pNameSpace,lLevel3);

                              lDARVADTStorage4.SETRANGE("Service No.",pServiceNo);
                              lDARVADTStorage4.SETRANGE("Service Header No.",pServiceHeaderNo);
                              lDARVADTStorage4.SETRANGE("Entry No.",pLastStorageEntryNo);
                              lDARVADTStorage4.SETRANGE("Parent Tag Entry No.",lDARVADTStorage3."Tag Entry No.");
                              IF lDARVADTStorage4.FINDSET THEN BEGIN
                                REPEAT
                                  lTextBuffer :=
                                    lDARVADTStorage4."Value 1" + lDARVADTStorage4."Value 2" + lDARVADTStorage4."Value 3" +
                                    lDARVADTStorage4."Value 4" + lDARVADTStorage4."Value 5";
                                  CASE lDARVADTStorage4."Tag Type" OF
                                    lDARVADTStorage4."Tag Type"::Tag : BEGIN
                                      EAIXMLDocMgt.AddElement(
                                        lLevel3,lDARVADTStorage4."Tag Description",lTextBuffer,pNameSpace,lLevel4);

                                      lDARVADTStorage5.SETRANGE("Service No.",pServiceNo);
                                      lDARVADTStorage5.SETRANGE("Service Header No.",pServiceHeaderNo);
                                      lDARVADTStorage5.SETRANGE("Entry No.",pLastStorageEntryNo);
                                      lDARVADTStorage5.SETRANGE("Parent Tag Entry No.",lDARVADTStorage4."Tag Entry No.");
                                      IF lDARVADTStorage5.FINDSET THEN BEGIN
                                        REPEAT
                                        UNTIL lDARVADTStorage5.NEXT = 0;
                                      END;
                                    END;
                                    lDARVADTStorage4."Tag Type"::Attribute : BEGIN
                                      EAIXMLDocMgt.AddAttribute(lLevel3,lDARVADTStorage4."Tag Description",lTextBuffer);
                                    END;
                                  END;
                                UNTIL lDARVADTStorage4.NEXT = 0;
                              END;
                            END;
                            lDARVADTStorage3."Tag Type"::Attribute : BEGIN
                              EAIXMLDocMgt.AddAttribute(lLevel2,lDARVADTStorage3."Tag Description",lTextBuffer);
                            END;
                          END;
                        UNTIL lDARVADTStorage3.NEXT = 0;
                      END;
                    END;
                    lDARVADTStorage2."Tag Type"::Attribute : BEGIN
                      EAIXMLDocMgt.AddAttribute(lLevel1,lDARVADTStorage2."Tag Description",lTextBuffer);
                    END;
                  END;
                UNTIL lDARVADTStorage2.NEXT = 0;
              END;
            END;
            lDARVADTStorage."Tag Type"::Attribute : BEGIN
              EAIXMLDocMgt.AddAttribute(pXMLNode,lDARVADTStorage."Tag Description",lTextBuffer);
            END;
          END;
        UNTIL lDARVADTStorage.NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE GetAgreement@1100281002(pServiceHeader@1000000000 : Record 5900;pIntervention@1000000001 : Record 50075) : Code[10];
    VAR
      lProviderAgreement@1100281000 : Record 50012;
      lCorporateRegion@1100281001 : Record 50058;
    BEGIN
      //IMH07
      lProviderAgreement.SETCURRENTKEY("Detail Corporate No.","Detail Corporate Region Code");
      lProviderAgreement.SETRANGE("Detail Corporate No.",pServiceHeader."Corporate No.");
      lProviderAgreement.SETRANGE("Detail Corporate Region Code",pServiceHeader."Corporate Region Code");
      lProviderAgreement.SETRANGE("Provider No.",pIntervention."Provider No.");
      IF lProviderAgreement.ISEMPTY THEN BEGIN
        lProviderAgreement.SETRANGE("Detail Corporate Region Code");
      END;
      IF NOT lProviderAgreement.ISEMPTY THEN BEGIN
        IF lProviderAgreement.FINDFIRST THEN BEGIN
          EXIT(lProviderAgreement."Agreement No.");
        END;
      END ELSE BEGIN
        lCorporateRegion.SETRANGE("Corporate No.",pServiceHeader."Corporate No.");
        lCorporateRegion.SETRANGE("Region Code",pServiceHeader."Corporate Region Code");
        IF lCorporateRegion.COUNT = 1 THEN BEGIN
          lCorporateRegion.FINDFIRST;
          EXIT(lCorporateRegion."SDR64 Provider No.");
        END;
      END;
    END;

    LOCAL PROCEDURE GetAmounts@1000000002(pVendorLedgerEntry@1100281006 : Record 25;VAR pAmountExclVAT@1100281007 : Decimal;VAR pAmountVAT@1100281003 : Decimal;VAR pPercentVAT@1100281004 : Decimal) : Decimal;
    VAR
      lGLEntry@1100281000 : Record 17;
      lVATPostingSetup@1100281001 : Record 325;
    BEGIN
      // r‚cupŠre les montants issue des ‚critures comptable li‚ au num‚ro de transmission ainsi que des services
      pAmountVAT := 0;
      pPercentVAT := 0;
      pAmountExclVAT := 0;

      WITH lGLEntry DO BEGIN
        //SETCURRENTKEY("Transmission No.");
        //SETRANGE("Transmission No.",pVendorLedgerEntry."Transmission No.");
        SETCURRENTKEY("Service No.","Service Header No.","Intervention Line No.");
        SETRANGE("Service No.",pVendorLedgerEntry."Service No.");
        SETRANGE("Service Header No.",pVendorLedgerEntry."Service Header No.");
        SETRANGE("Intervention Line No.",pVendorLedgerEntry."Intervention Line No.");
        SETRANGE("Gen. Posting Type","Gen. Posting Type"::Purchase);
        SETRANGE("Document Type",pVendorLedgerEntry."Document Type");
        SETRANGE("Document No.",pVendorLedgerEntry."Document No.");
        IF ISEMPTY THEN BEGIN
          EXIT;
        END;

        FINDSET;
        // doit ˆtre r‚cup‚r‚ sur le PV
        lVATPostingSetup.GET("VAT Bus. Posting Group","VAT Prod. Posting Group");
        pPercentVAT := lVATPostingSetup."VAT %";
        REPEAT
          pAmountExclVAT += Amount;
          pAmountVAT += "VAT Amount";
        UNTIL NEXT = 0;
      END;
    END;

    PROCEDURE GetNumPartie@1000000005(pVendorLedgerEntry@1000000003 : Record 25) rValue : Text[1024];
    VAR
      lServiceInterventionLine@1000000002 : Record 50075;
      lInterfaceReference@1000000001 : Record 50164;
      lProvider@1000000004 : Record 50000;
      lExitLoop@1000000000 : Boolean;
    BEGIN
      // IMH05.PC

      rValue := '';

      lServiceInterventionLine.GET(pVendorLedgerEntry."Service Header No.",pVendorLedgerEntry."Intervention Line No.");
      lProvider.GET(lServiceInterventionLine."Provider No.");
      lExitLoop := FALSE;
      lInterfaceReference.SETRANGE("Source Table ID",DATABASE::"Service Intervention Line");
      lInterfaceReference.SETRANGE("Source No.",pVendorLedgerEntry."Service No.");
      lInterfaceReference.SETRANGE("Source No. 2",pVendorLedgerEntry."Service Header No.");
      lInterfaceReference.SETRANGE("Source No. 3",pVendorLedgerEntry."Intervention Line No.");
      lInterfaceReference.SETFILTER("DARVA Reference",'<>%1','');
      IF NOT lInterfaceReference.FINDFIRST THEN BEGIN
        lInterfaceReference.SETFILTER("Source No. 3",'<>%1',pVendorLedgerEntry."Intervention Line No.");
        IF lInterfaceReference.FINDSET THEN BEGIN
          REPEAT
            lServiceInterventionLine.GET(lInterfaceReference."Source No. 2",lInterfaceReference."Source No. 3");
            lExitLoop := lProvider."No." = lServiceInterventionLine."Provider No.";
            rValue := lInterfaceReference."DARVA Reference";
          UNTIL (lInterfaceReference.NEXT = 0) OR lExitLoop;
        END;
      END ELSE BEGIN
        rValue := lInterfaceReference."DARVA Reference";
      END;
    END;

    LOCAL PROCEDURE CreateHeaderFlow@1100281005(VAR pXMLDocument@1100281001 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{88D96A05-F192-11D4-A65F-0040963251E5}:'Microsoft XML, v6.0'.DOMDocument60";pNodeRootName@1100281002 : Text[30];VAR pNode@1100281003 : Automation "{F5078F18-C551-11D3-89B9-0000F81FE221} 6.0:{2933BF80-7B36-11D2-B20E-00C04F983E60}:'Microsoft XML, v6.0'.IXMLDOMNode");
    VAR
      lEAIXMLDocumentManagement@1100281000 : Codeunit 8016713;
    BEGIN
      CLEAR(pXMLDocument);
      CLEAR(pNode);
      CREATE(pXMLDocument);

      IF ISCLEAR(pXMLDocument) THEN BEGIN
        CREATE(pXMLDocument);
      END;

      IF pXMLDocument.loadXML('<' + pNodeRootName + '/>') THEN BEGIN
        pNode := pXMLDocument.documentElement;
      END;
    END;

    LOCAL PROCEDURE ReplaceSpecialChar@1000000004(pText@1100281000 : Text[80]) rValue : Text[80];
    VAR
      lDARVAMgt@1000000000 : Codeunit 50150;
      lToolsMgt@1000000001 : Codeunit 8016602;
    BEGIN
      // IMH10.PC

      //rValue := lDARVAMgt.ReplaceSpecialChar(pText);
      rValue := DeleteAccentChar(pText);
    END;

    LOCAL PROCEDURE DeleteMailInvalidChar@1000000003(pText@1100281000 : Text[250]) : Text[250];
    BEGIN
      //IMH12
      EXIT(DELCHR(pText,'=',' '));
    END;

    LOCAL PROCEDURE GetFormatAttachment@1000000006(pExtension@1000000000 : Code[10]) : Code[10];
    BEGIN
      //IMH02.ACO
      CASE pExtension OF
      'BMP', 'DOC', 'DOCX', 'GIF', 'HTML', 'PDF', 'PNG', ' TIF', 'TXT', 'XLS', 'XLSX','ZIP':
        EXIT(pExtension);
      'JPG':
        EXIT('JPEG');
      ELSE
        EXIT('9999');
      END
    END;

    LOCAL PROCEDURE GetDARVACarrierSubNo@1000000000(pServiceHeader@1000000000 : Record 5900) rValue : Code[20];
    VAR
      lCustomer@1000000001 : Record 18;
      lCorporateRegion@1000000002 : Record 50058;
    BEGIN
      IF lCorporateRegion.GET(pServiceHeader."Corporate No.",pServiceHeader."Corporate Region Code") THEN BEGIN
        rValue := lCorporateRegion."DARVA Subscriber No.";
      END;

      IF rValue = '' THEN BEGIN
        IF lCustomer.GET(pServiceHeader."Corporate No.") THEN BEGIN
          rValue := lCustomer."DARVA Subscriber No.";
        END;
      END;
    END;

    LOCAL PROCEDURE DeleteAccentChar@1000000001(pText@1000000000 : Text[1024]) rValue : Text[1024];
    VAR
      lFromChar@1000000001 : Text[1024];
      lToChar@1000000002 : Text[1024];
    BEGIN

      lFromChar := '·µ¶ÇŽ… ƒÆ„†€‡ÔÒÓŠ‚ˆ‰ÞÖ×Ø¡Œ‹ãàâå™•¢“ä”ëéêš—£–íì˜’Ñ¥žèá‘Ð¤ö›çøñý';
      lToChar   := 'AAAAAAaaaaaaCcEEEEeeeeIIIIiiiiOOOOOoooooUUUUuuuuYyy                ';
      rValue := CONVERTSTR(pText,lFromChar,lToChar);
    END;

    BEGIN
    {
      /** @r IMH14 @d 18/02/14 @s ISAT.ACO @v IMH6.01.4964 @s Mauvais nø facture @h 4964
          @c R‚cup‚rer nø facture … partir du Nø facture fournisseur */
      /** @r IMH13 @d 12/02/14 @s ISAT.ACO @v IMH6.01.4986 @s Nature des dommages @h 4986
          @c Ajout nature des dommages et descriptif */
      /** @r IMH12 @d 15/01/15 @s ISAT.ACO @v IMH6.01.4949 @s Montant DRT @h 4949
          @c Montant de la DRT doit ˆtre montant net TTC (hors franchise )
          @c Prestataire est syst‚matiquement assujetti … la TVA */
      /** @r IMH11 @d 07/01/14 @a ISAT.ACO @v IMH6.01.4940 @s R‚cup‚ration facture rattach‚e @h 4940
          @c R‚cup‚ration du flux correspondant au nøfacture de l'‚criture
          @c Correction effacement flux si flux en erreur reg‚n‚r‚ */
      /** @r IMH10 @d 06/01/14 @a ISAT.ZW @v IMH6.01.4938 @s Gesiton caractŠres sp‚ciaux @h 4938 @c Gesiton caractŠres sp‚ciaux */
      /** @r IMH09 @d 27/11/13 @a ISAT.PC @v IMH6.01.348 @s DARVA MATMUT Lot 1 @h 4889 @c Correction */
      /** @r IMH08 @d 25/11/13 @a ISAT.PC @v IMH6.01.348 @s DARVA MATMUT Lot 1 @h 4882 @c Correction */
      /** @r IMH07 @d 25/11/13 @a ISAT.PC @v IMH6.01.348 @s DARVA MATMUT Lot 1 @h 4879 @c Correction */
      /** @r IMH06 @d 20/11/13 @a ISAT.PC @v IMH6.01.348 @s DARVA MATMUT Lot 1 @c Suite SFD 0.8 - Modification */
      /** @r IMH05 @d 18/11/13 @a ISAT.PC @v IMH6.01.348 @h 4862 @s DARVA MATMUT Lot 1 @c Correctif */
      /** @r IMH04 @d 18/11/13 @a ISAT.PC @v IMH6.01.348 @h 4865 @s DARVA MATMUT Lot 1 @c Correctif */
      /** @r IMH03 @d 07/11/13 @a ISAT.PC @v IMH6.01.348 @h 4859 @s DARVA MATMUT Lot 1 @c Cr‚ation */
      /** @r IMH02 @d 25/10/13 @a ISAT.PC @v IMH6.01.348 @h 4848 @s DARVA MATMUT Lot 1 @c Cr‚ation */
      /** @r IMH01 @d 21/08/13 @a ISAT.PC @v IMH6.01.348 @s DARVA MATMUT Lot 1 @c Cr‚ation */
    }
    END.
  }
}